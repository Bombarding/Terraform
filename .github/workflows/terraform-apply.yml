---
name: Terraform Apply
on:
    workflow_dispatch:

jobs:
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
        - name: Checkout
          uses: actions/checkout@v3

        - name: Configure AWS Credentials Action For GitHub Actions
          uses: aws-actions/configure-aws-credentials@v1
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ secrets.AWS_REGION }}

        - name: Run Terraform Apply
          uses: dflook/terraform-apply@v1
          with:
            path: terraform/
            auto_approve: true
            backend_config: >
              access_key=${{ secrets.AWS_ACCESS_KEY_ID }},
              secret_key=${{ secrets.AWS_SECRET_ACCESS_KEY }},
              bucket=${{ secrets.AWS_BUCKET }},

        - name: terraform destroy
          uses: dflook/terraform-destroy@v1
          continue-on-error: true
          with:
            path: terraform/
            workspace: ${{ github.head_ref }}
